// CharacterForge.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.6.0;

import "./ShardForge.sol";
import "./Cooldown.sol";

/*
    Deployed 
    Goerli 0.1 - 0x6Ca442A4F8bAEfAc47e9710641b7F4d6B65Ee8c3 (admin 0x13C5e101b3Dde6063FE68afD3DA18645F6060B2c)
    Goerli 0.2 - 0xf9b9c3b712334AA91CeAa47bC37202Bb863FddEe (admin 0x13C5e101b3Dde6063FE68afD3DA18645F6060B2c)
*/
contract CharacterLocation is PausableCPX {
    // Create a new role identifier for the minter role
    bytes32 public constant MOVER_ROLE = keccak256("MOVER_ROLE");
    
    //contracts 
    OutlandsShards internal OS; 
    Gatekeeper internal GK;
    Cooldown internal Cool;

    //location - characetr => shard id  
    mapping (uint256 => bytes32) public shardLocation;
    
    //Events 
    event Move(uint256 id, bytes32 shard);
    
    //constructor
    constructor(Gatekeeper gk, OutlandsShards os, Cooldown cool)
        public
    {
        GK = gk;
        OS = os;
        Cool = cool;
    }
    
    /*
        Internal Functions 
    */
    
    function _move (uint256 id, bytes32 toShard)
        internal
    {
        require(!_isPaused, "The contract is paused.");

        //cooldown time
        uint256 _time = block.timestamp + OS.getTravelTime(shardLocation[id], toShard);

        //set cooldown
        Cool.setIdCooldown(id, _time);
        
        //set location
        shardLocation[id] = toShard;
        
        //emit 
        emit Move(id, toShard);
    }

    /*
        External Functions 
    */
    
    function setContracts (Gatekeeper gk, OutlandsShards os, Cooldown cool)
        public
    {
        require(hasRole(DEFAULT_ADMIN_ROLE, msg.sender), "No permission.");
        GK = gk;
        OS = os;
        Cool = cool;
    }
    
    function moveFor (uint256 id, bytes32 toShard, bool useCooldown) 
        public
    {
        require(hasRole(MOVER_ROLE, msg.sender), "Caller is not authorized.");
        
        if(useCooldown) {
            _move(id, toShard);
        }
        else {
            //set location
            shardLocation[id] = toShard;
            
            //emit 
            emit Move(id, toShard);
        }
    }
    
    function init (uint256 id, bytes32 seed) 
        public
    {
        require(!_isPaused, "The contract is paused.");
        require(shardLocation[id] == bytes32(0), "Location is already set.");
        //check for ownership 
        require(GK.balanceOf(msg.sender, id) == 1, "You do not own the character.");
        
        //set location
        shardLocation[id] = seed;
            
        //emit 
        emit Move(id, shardLocation[id]);
    }
    
    function move (uint256 id, bytes32 toShard) 
        public
    {
        //check for ownership 
        require(GK.balanceOf(msg.sender, id) == 1, "You do not own the character.");
        require(Cool.cooldown(id) < block.timestamp, "Character is in cooldown.");
        
        //move 
        _move(id, toShard);
    }
}